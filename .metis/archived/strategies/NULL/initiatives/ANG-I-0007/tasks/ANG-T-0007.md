---
id: add-mcp-server-startup-test
level: task
title: "Add MCP server startup test"
short_code: "ANG-T-0007"
created_at: 2025-12-31T14:49:05.716377+00:00
updated_at: 2025-12-31T14:49:05.716377+00:00
parent: ANG-I-0007
blocked_by: []
archived: true

tags:
  - "#task"
  - "#phase/todo"


exit_criteria_met: false
strategy_id: NULL
initiative_id: ANG-I-0007
---

# Add MCP server startup test

## Parent Initiative

[[ANG-I-0007]] - MCP Server and Installation Testing

## Objective

Create an automated test that verifies the MCP server starts correctly without panicking, accepts an `initialize` request, and returns a valid JSON-RPC response. This catches regressions like the tracing subscriber panic we hit in v2.7.1.

## Acceptance Criteria

## Acceptance Criteria

- [ ] Test spawns `angreal mcp` as subprocess
- [ ] Test verifies process doesn't exit/panic within 2 seconds
- [ ] Test sends MCP `initialize` request via stdin
- [ ] Test validates JSON-RPC response structure
- [ ] Test terminates server gracefully
- [ ] Test passes in CI environment

## Implementation Notes

### Technical Approach

Add to `.angreal/task_tests.py`:

```python
import subprocess
import json
import time

def test_mcp_server_startup():
    """Test MCP server starts and responds to initialize."""
    # Start server
    proc = subprocess.Popen(
        ["angreal", "mcp"],
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True
    )

    # Give it time to start (would panic immediately if broken)
    time.sleep(1)

    # Check it's still running
    if proc.poll() is not None:
        stderr = proc.stderr.read()
        raise AssertionError(f"MCP server exited early: {stderr}")

    # Send initialize request
    init_request = {
        "jsonrpc": "2.0",
        "id": 1,
        "method": "initialize",
        "params": {
            "protocolVersion": "2024-11-05",
            "capabilities": {},
            "clientInfo": {"name": "test", "version": "1.0"}
        }
    }
    proc.stdin.write(json.dumps(init_request) + "\n")
    proc.stdin.flush()

    # Read response
    response = proc.stdout.readline()
    result = json.loads(response)

    # Validate response
    assert result.get("jsonrpc") == "2.0"
    assert result.get("id") == 1
    assert "result" in result

    # Cleanup
    proc.terminate()
    proc.wait(timeout=5)
```

### Dependencies

- Requires angreal to be installed in test environment
- No external dependencies beyond stdlib

### Risk Considerations

- Server may hang if protocol changes - add timeout
- Different behavior in/out of angreal project - test both contexts
