---
id: add-installation-smoke-tests
level: task
title: "Add installation smoke tests"
short_code: "ANG-T-0009"
created_at: 2025-12-31T14:49:24.942876+00:00
updated_at: 2025-12-31T14:49:24.942876+00:00
parent: ANG-I-0007
blocked_by: []
archived: true

tags:
  - "#task"
  - "#phase/todo"


exit_criteria_met: false
strategy_id: NULL
initiative_id: ANG-I-0007
---

# Add installation smoke tests

## Parent Initiative

[[ANG-I-0007]] - MCP Server and Installation Testing

## Objective

Create smoke tests that verify angreal installs correctly and core commands work. These tests catch issues like missing dependencies, broken entry points, or runtime panics that only manifest after installation.

## Acceptance Criteria

## Acceptance Criteria

- [ ] Test builds wheel with maturin
- [ ] Test installs wheel in isolated venv
- [ ] Test runs `angreal --version` and verifies output
- [ ] Test runs `angreal --help` and verifies no errors
- [ ] Test runs `angreal mcp` briefly and verifies no immediate crash
- [ ] Test runs outside angreal project to verify graceful handling
- [ ] All tests pass on Linux, macOS, and Windows

## Implementation Notes

### Technical Approach

Add new `smoke` command group to `.angreal/task_tests.py`:

```python
smoke = angreal.command_group(name="smoke", about="installation smoke tests")

@smoke()
@angreal.command(name="install", about="Test fresh installation")
def smoke_install():
    """Build and install in isolated environment, run basic commands."""

    with tempfile.TemporaryDirectory() as tmpdir:
        # Create isolated venv
        venv_path = Path(tmpdir) / "venv"
        subprocess.run([sys.executable, "-m", "venv", str(venv_path)], check=True)

        if sys.platform == "win32":
            pip = venv_path / "Scripts" / "pip.exe"
            angreal_bin = venv_path / "Scripts" / "angreal.exe"
        else:
            pip = venv_path / "bin" / "pip"
            angreal_bin = venv_path / "bin" / "angreal"

        # Build wheel
        wheel_dir = Path(tmpdir) / "wheels"
        subprocess.run([
            "maturin", "build", "--release",
            "--manifest-path", str(project_root / "crates" / "angreal" / "Cargo.toml"),
            "--out", str(wheel_dir)
        ], check=True)

        # Install
        wheel = list(wheel_dir.glob("*.whl"))[0]
        subprocess.run([str(pip), "install", str(wheel)], check=True)

        # Test --version
        result = subprocess.run([str(angreal_bin), "--version"],
                                capture_output=True, text=True)
        assert result.returncode == 0
        assert "angreal" in result.stdout.lower()
        print(f"✅ --version: {result.stdout.strip()}")

        # Test --help
        result = subprocess.run([str(angreal_bin), "--help"],
                                capture_output=True, text=True)
        assert result.returncode == 0
        assert "USAGE" in result.stdout or "Usage" in result.stdout
        print("✅ --help works")

        # Test mcp doesn't crash immediately (run outside project)
        result = subprocess.run([str(angreal_bin), "mcp"],
                                capture_output=True, text=True, timeout=3)
        # MCP should still be running (we killed it with timeout) or exit cleanly
        # It should NOT have a panic in stderr
        assert "panic" not in result.stderr.lower()
        print("✅ mcp server starts without panic")
```

### Dependencies

- Requires maturin for wheel building
- Requires system Python with venv module

### Risk Considerations

- Wheel building is slow (~2-3 min) - consider caching in CI
- Platform-specific paths need handling
- Timeout for MCP test needs tuning
