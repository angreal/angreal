---
id: add-streaming-progress-support-to
level: task
title: "Add streaming progress support to MCP tools"
short_code: "ANG-T-0011"
created_at: 2025-12-31T15:04:46.227455+00:00
updated_at: 2025-12-31T15:04:46.227455+00:00
parent:
blocked_by: []
archived: true

tags:
  - "#task"
  - "#phase/backlog"
  - "#feature"


exit_criteria_met: false
strategy_id: NULL
initiative_id: NULL
---

# Add streaming progress support to MCP tools

## Objective

Enable angreal MCP tools to stream progress updates back to AI agents during long-running task execution. Currently, tool calls block until completion - for tasks like `angreal test all` or builds that take minutes, the agent has no visibility into progress.

## Backlog Item Details

### Type
- [x] Feature - New functionality or enhancement

### Priority
- [ ] P1 - High (important for user experience)

### Business Justification
- **User Value**: AI agents can see real-time progress of long-running tasks, improving UX and allowing them to provide updates to users
- **Business Value**: Better integration experience encourages adoption of angreal with AI assistants
- **Effort Estimate**: M (medium) - requires changes to tool execution model

## Acceptance Criteria

## Acceptance Criteria

- [ ] MCP server extracts `progressToken` from incoming `tools/call` requests
- [ ] Tool execution streams stdout/stderr lines as progress notifications
- [ ] Progress includes line count or percentage where determinable
- [ ] Agent receives progress updates before final tool result
- [ ] Works with Claude Code and other MCP clients that support progress
- [ ] Graceful fallback if client doesn't provide progressToken

## Implementation Notes

### Technical Approach

#### 1. Capture Progress Token

When handling `tools/call`, extract the progress token from request metadata:

```rust
// In handle_call_tool
let progress_token = request._meta
    .as_ref()
    .and_then(|m| m.progress_token.clone());
```

#### 2. Async Tool Execution with Streaming

Instead of `subprocess.run()`, use async streaming:

```rust
async fn execute_tool_streaming(
    &self,
    command: &str,
    args: Vec<String>,
    progress_token: Option<ProgressToken>,
    server: Arc<dyn McpServer>,
) -> Result<ToolResult> {
    let mut child = Command::new("angreal")
        .args(&args)
        .stdout(Stdio::piped())
        .stderr(Stdio::piped())
        .spawn()?;

    let stdout = child.stdout.take().unwrap();
    let reader = BufReader::new(stdout);
    let mut lines = reader.lines();
    let mut line_count = 0;

    while let Some(line) = lines.next_line().await? {
        line_count += 1;

        // Send progress notification if token provided
        if let Some(ref token) = progress_token {
            server.notify_progress(ProgressNotificationParams {
                progress_token: token.clone(),
                progress: line_count as f64,
                total: None,  // Unknown total
                message: Some(line.clone()),
            }).await?;
        }
    }

    let status = child.wait().await?;
    // Return final result...
}
```

#### 3. Progress Message Format

Stream meaningful progress messages:
- For stdout: `"[stdout] {line}"`
- For stderr: `"[stderr] {line}"`
- For milestones: `"Running test 5/20..."`

#### 4. Alternative: Logging Notifications

MCP also supports `notifications/message` for logging. Could use this for real-time output:

```rust
server.send_log_message(LoggingMessageNotificationParams {
    level: LoggingLevel::Info,
    data: serde_json::json!({"output": line}),
    logger: Some("angreal".to_string()),
}).await?;
```

### Dependencies

- rust-mcp-sdk already has `notify_progress()` method
- Need to refactor tool handler to be async-aware
- May need to pass server reference into handler

### Risk Considerations

- **Buffering**: Large output could flood notifications - consider rate limiting
- **Client Support**: Not all MCP clients may display progress - test with Claude Code
- **Stderr handling**: Need to interleave stdout/stderr properly
- **Cancellation**: Long-running tasks should be cancellable - MCP has cancel support

### References

- [MCP Progress Specification](https://spec.modelcontextprotocol.io/specification/2024-11-05/basic/utilities/progress/)
- rust-mcp-sdk `McpServer::notify_progress()` method
