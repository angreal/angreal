---
id: task-harness-cleanup-and-best
level: task
title: "Task harness cleanup and best practices alignment"
short_code: "ANG-T-0012"
created_at: 2025-12-31T15:59:29.762454+00:00
updated_at: 2025-12-31T15:59:29.762454+00:00
parent:
blocked_by: []
archived: true

tags:
  - "#task"
  - "#phase/completed"
  - "#tech-debt"


exit_criteria_met: true
strategy_id: NULL
initiative_id: NULL
---

# Task harness cleanup and best practices alignment

Align `.angreal/` task files with angreal best practices and clean up technical debt.

## Objective

Refactor the angreal task harness to follow documented best practices, improve maintainability, and ensure proper MCP integration through ToolDescriptions.

## Backlog Item Details

### Type
- [x] Tech Debt - Code improvement or refactoring

### Priority
- [x] P2 - Medium (nice to have)

### Technical Debt Impact
- **Current Problems**:
  - `when_to_use`/`when_not_to_use` used but not surfaced to MCP (dead code)
  - Missing `ToolDescription` objects on most commands
  - Inconsistent error handling (`exit()` vs `return`)
  - `task_tests.py` is 800+ lines
  - Inconsistent `project_root` patterns across files
  - `all_tests()` doesn't check return codes from sub-tests
- **Benefits of Fixing**:
  - Proper MCP tool discoverability with risk levels
  - Consistent, predictable task behavior
  - Better maintainability with smaller files
  - Sub-test failures properly propagate
- **Risk Assessment**: Low risk - internal tooling only

## Acceptance Criteria

## Acceptance Criteria

- [x] Remove all `when_to_use`/`when_not_to_use` from task decorators
- [x] Add `ToolDescription` with `risk_level` to all commands
- [x] Replace all `exit()`/`sys.exit()` with `return` statements
- [x] Fix `all_tests()` to check return codes from sub-tests
- [x] Standardize `project_root` to use `Path(angreal.get_root()).parent`
- [x] Rename `task_tests.py` to `task_test.py` (singular convention)
- [x] Consider splitting large file into `task_test.py`, `task_test_mcp.py`, `task_smoke.py`
- [x] Replace `shell=True` subprocess calls with explicit argument lists

## Implementation Notes

### Files to Modify

1. **`.angreal/task_tests.py`** (most changes)
   - Remove `when_to_use`/`when_not_to_use` from all `@angreal.command()` calls
   - Add `tool=angreal.ToolDescription(...)` to: `all`, `python`, `rust`, `completion`, `mcp startup`, `mcp tools`, `mcp all`, `smoke install`
   - Replace `exit(1)` with `return 1` at lines: 103, 160-163, 170-173, 561, 631, 634, 750, 763, 766, 777, 780, 800
   - Replace `sys.exit(1)` with `return 1` at lines: 488, 523, 526
   - Fix `all_tests()` to check return values
   - Replace `shell=True` at lines 159, 170
   - Rename file to `task_test.py`

2. **`.angreal/task_docs.py`**
   - Remove `when_to_use`/`when_not_to_use`
   - Add `ToolDescription` to: `clean` (destructive), `serve` (safe), `build` (safe)
   - Standardize `PROJECT_ROOT` naming

3. **`.angreal/task_dev.py`**
   - Already has proper `ToolDescription`
   - Standardize `project_root` to use `Path`

### Risk Levels for ToolDescriptions

| Command | Risk Level |
|---------|------------|
| `test *` | safe |
| `docs clean` | destructive |
| `docs serve` | safe |
| `docs build` | safe |
| `smoke install` | safe |
| `dev check-deps` | read_only |

### Dependencies

None - internal refactoring only.

## Status Updates

**2025-12-31**: Completed all tech debt cleanup:
- Replaced all `when_to_use`/`when_not_to_use` with `ToolDescription` objects
- Added proper `risk_level` annotations to all commands
- Fixed all `exit()`/`sys.exit()` to use `return` statements
- Fixed `all_tests()` and `test_mcp_all()` to properly check and propagate return codes
- Replaced `shell=True` subprocess calls with explicit argument lists
- Renamed `task_tests.py` to `task_test.py` (singular convention)
- `project_root` already standardized to `Path(angreal.get_root()).parent`
- Split large file into three modules:
  - `task_test.py` (464 lines) - Core tests (python, rust, completion)
  - `task_test_mcp.py` (307 lines) - MCP server tests
  - `task_smoke.py` (148 lines) - Installation smoke tests
