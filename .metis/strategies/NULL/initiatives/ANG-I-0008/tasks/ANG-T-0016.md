---
id: implement-flox-required-decorator
level: task
title: "Implement flox_required decorator"
short_code: "ANG-T-0016"
created_at: 2026-01-13T01:30:12.808096+00:00
updated_at: 2026-01-13T02:01:23.695862+00:00
parent: ANG-I-0008
blocked_by: []
archived: false

tags:
  - "#task"
  - "#phase/completed"


exit_criteria_met: false
strategy_id: NULL
initiative_id: ANG-I-0008
---

# Implement flox_required decorator

## Objective

Implement the `@flox_required` decorator for task-scoped Flox environment activation with optional service management.

## Acceptance Criteria

## Acceptance Criteria

- [x] `flox_required(path, services=None)` pyfunction returning decorator
- [x] `FloxRequiredDecorator` pyclass implementing `__call__` to wrap functions
- [x] `FloxRequiredWrapper` pyclass that:
  - Creates/activates Flox environment before function execution
  - Optionally starts specified services
  - Calls wrapped function
  - Stops services and deactivates environment after (even on exception)
- [x] Proxy `__name__`, `__arguments__` from wrapped function (for angreal introspection)
- [x] Python tests for decorator (11 tests: 6 unit tests, 5 integration tests)

## Implementation Notes

### Usage Pattern
```python
@angreal.command(name="test")
@flox_required(".", services=["postgres"])
def run_tests():
    subprocess.run(["pytest"])
```

### Decorator Flow
1. Create `Flox` instance for path
2. Call `flox.activate()`
3. If services specified, call `flox.services.start(*services)`
4. Execute wrapped function
5. Stop services (if started)
6. Call `flox.deactivate()`
7. Return function result (or re-raise exception)

### Pattern Reference
See `venv_required` implementation in `crates/angreal/src/python_bindings/venv.rs`.

### Dependencies
- Requires ANG-T-0014 (Flox class)
- Requires ANG-T-0015 (FloxServices class)

## Status Updates

### Completed

**Files Modified:**
- `crates/angreal/src/python_bindings/integrations/flox.rs` - Added flox_required, FloxRequiredDecorator, FloxRequiredWrapper
- `py_tests/integrations/test_flox.py` - Added 11 decorator tests (6 unit, 5 integration)

**Implementation Details:**
- `flox_required(path=None, services=None)` creates a decorator for task-scoped Flox environments
- `FloxRequiredDecorator.__call__` wraps functions with `FloxRequiredWrapper`
- `FloxRequiredWrapper.__call__` handles the full lifecycle:
  1. Create and activate Flox environment
  2. Start services if specified
  3. Call wrapped function with args/kwargs
  4. Stop services (cleanup)
  5. Deactivate environment (even on exception)
- Proxies `__name__`, `__arguments__` for angreal CLI introspection
- All 143 tests passing (54 Flox-specific tests)
